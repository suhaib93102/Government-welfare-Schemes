# Razorpay Payment Architecture & Diagrams

Visual architecture and diagrams for Razorpay payment integration.

---

## ðŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER DEVICE                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      React Native App                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  PaymentScreen.tsx                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Plan selection                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Payment history                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Refund requests                                       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                   â”‚                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  paymentService.ts                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Create order                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Process payment                                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Verify signature                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Manage history                                        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    DJANGO BACKEND                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  payment_views.py                                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ CreatePaymentOrderView (POST)                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ VerifyPaymentView (POST)                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ PaymentStatusView (GET)                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ PaymentHistoryView (GET)                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ RefundPaymentView (POST)                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ RazorpayKeyView (GET)                                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                   â”‚                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  payment_service.py                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Order creation                                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Signature verification (HMAC-SHA256)                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Payment details fetching                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Refund processing                                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                   â”‚                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  models.py                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Payment (razorpay_order_id, razorpay_payment_id)     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ UserSubscription (plan, auto_pay_enabled)            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ FeatureUsageLog                                       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                   â”‚                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  SQLite Database                                         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS (REST API)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RAZORPAY API    â”‚     â”‚  RAZORPAY        â”‚
â”‚   - Orders        â”‚     â”‚  CHECKOUT        â”‚
â”‚   - Payments      â”‚     â”‚  - Modal UI      â”‚
â”‚   - Refunds       â”‚     â”‚  - Payment forms â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Payment Processing Sequence

```
User                Frontend            Backend            Razorpay
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚ Select plan & Pay  â”‚                   â”‚                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
 â”‚                    â”‚ Create order      â”‚                   â”‚
 â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
 â”‚                    â”‚                   â”‚ Create order      â”‚
 â”‚                    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                    â”‚                   â”‚  order_id         â”‚
 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
 â”‚                    â”‚ order_id, key_id  â”‚                   â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
 â”‚ Show checkout      â”‚                   â”‚                   â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚  User enters card  â”‚                   â”‚                   â”‚
 â”‚  and completes     â”‚ Process payment   â”‚                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                   â”‚    Authorize &    â”‚
 â”‚                    â”‚                   â”‚    Capture        â”‚
 â”‚                    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                    â”‚                   â”‚  payment_id, sig  â”‚
 â”‚                    â”‚                   â”‚                   â”‚
 â”‚  Success callback  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ order_id, pay_id, â”‚                   â”‚
 â”‚                   â”‚ signature          â”‚                   â”‚
 â”‚                   â”‚ Verify signature   â”‚                   â”‚
 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
 â”‚                   â”‚                   â”‚ Verify HMAC-SHA256â”‚
 â”‚                   â”‚                   â”‚ Update DB         â”‚
 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
 â”‚                   â”‚  Success response â”‚                   â”‚
 â”‚                   â”‚                   â”‚                   â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
 â”‚ Payment confirmed â”‚                   â”‚                   â”‚
 â”‚ Subscription      â”‚                   â”‚                   â”‚
 â”‚ upgraded          â”‚                   â”‚                   â”‚
 â”‚                   â”‚                   â”‚                   â”‚
```

---

## ðŸ“Š Database Schema Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       UserSubscription             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                          â”‚
â”‚ user_id (CharField)                â”‚
â”‚ plan (CharField: free/premium)     â”‚
â”‚ auto_pay_enabled (Boolean)         â”‚
â”‚ subscription_start_date (DateTime) â”‚
â”‚ subscription_end_date (DateTime)   â”‚
â”‚ next_billing_date (DateTime)       â”‚
â”‚ last_payment_date (DateTime)       â”‚
â”‚ created_at, updated_at             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ 1:N
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Payment                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                           â”‚
â”‚ subscription (FK)                   â”‚
â”‚ amount (Decimal)                    â”‚
â”‚ currency (CharField: INR)           â”‚
â”‚ status (CharField)                  â”‚
â”‚   - pending                         â”‚
â”‚   - completed                       â”‚
â”‚   - failed                          â”‚
â”‚   - refunded                        â”‚
â”‚ payment_method (CharField)          â”‚
â”‚ transaction_id (CharField)          â”‚
â”‚                                     â”‚
â”‚ Razorpay Fields:                    â”‚
â”‚ razorpay_order_id (CharField)       â”‚
â”‚ razorpay_payment_id (CharField)     â”‚
â”‚ razorpay_signature (CharField)      â”‚
â”‚                                     â”‚
â”‚ billing_cycle_start (DateTime)      â”‚
â”‚ billing_cycle_end (DateTime)        â”‚
â”‚ created_at, updated_at              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FeatureUsageLog                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                           â”‚
â”‚ subscription (FK)                   â”‚
â”‚ feature_name (CharField)            â”‚
â”‚ usage_type (CharField)              â”‚
â”‚ input_size (Integer)                â”‚
â”‚ created_at (DateTime)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” Signature Verification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Razorpay Returns After Payment     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                   â”‚
â”‚   "razorpay_order_id": "order_...", â”‚
â”‚   "razorpay_payment_id": "pay_...", â”‚
â”‚   "razorpay_signature": "sig_..."   â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Sends to Backend          â”‚
â”‚  POST /api/payment/verify/          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Calculates Signature       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ message = order_id|payment_id   â”‚â”‚
â”‚  â”‚                                 â”‚â”‚
â”‚  â”‚ expected_sig = HMAC-SHA256(     â”‚â”‚
â”‚  â”‚   key=RAZORPAY_KEY_SECRET,      â”‚â”‚
â”‚  â”‚   msg=message                   â”‚â”‚
â”‚  â”‚ )                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compare Signatures                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  expected_sig == razorpay_sig ?     â”‚
â”‚                                     â”‚
â”‚      YES âœ“        NO âœ—              â”‚
â”‚       â”‚            â”‚                â”‚
â”‚       â–¼            â–¼                â”‚
â”‚   Verify OK   Fraud Alert!          â”‚
â”‚   Update DB   Return Error          â”‚
â”‚   Upgrade     No subscription       â”‚
â”‚   Plan        upgrade               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##  API Request/Response Cycle

### Create Order Request
```
POST /api/payment/create-order/
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "plan": "premium",
  "auto_pay": false
}
```

### Create Order Response
```json
{
  "success": true,
  "order_id": "order_1A2B3C4D5E6F",
  "amount": 199,
  "amount_paise": 19900,
  "currency": "INR",
  "key_id": "rzp_test_XXXXXXXXXX",
  "plan": "premium",
  "payment_record_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Verify Payment Request
```
POST /api/payment/verify/
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "razorpay_order_id": "order_1A2B3C4D5E6F",
  "razorpay_payment_id": "pay_1A2B3C4D5E6F",
  "razorpay_signature": "a1b2c3d4e5f6...",
  "auto_pay": false
}
```

### Verify Payment Response
```json
{
  "success": true,
  "message": "Payment verified successfully",
  "payment_id": "pay_1A2B3C4D5E6F",
  "status": "completed",
  "subscription_updated": true,
  "plan": "premium"
}
```

---

## ðŸ”— Integration Points

### With Authentication System
```
paymentService.ts
    â”‚
    â”œâ”€â”€> authService.getAccessToken()
    â”‚    Get JWT token from storage
    â”‚
    â”œâ”€â”€> Authorization: Bearer <token>
    â”‚    Attach to all payment API calls
    â”‚
    â””â”€â”€> authService.getUserEmail()
         Pre-fill Razorpay checkout form
```

### With Subscription System
```
PaymentScreen.tsx
    â”‚
    â”œâ”€â”€> Check UserSubscription.plan
    â”‚    Show current plan status
    â”‚
    â”œâ”€â”€> Call payment API
    â”‚    Create Razorpay order
    â”‚
    â”œâ”€â”€> After verification
    â”‚    Update UserSubscription.plan to 'premium'
    â”‚    Set next_billing_date
    â”‚
    â””â”€â”€> Enable premium features
         Based on updated plan
```

### With Feature Access System
```
Feature Usage (existing)
    â”‚
    â”œâ”€â”€> Check UserSubscription.plan
    â”‚    Free: limited requests/day
    â”‚    Premium: unlimited requests
    â”‚
    â””â”€â”€> After payment â†’ subscription upgraded
         User immediately gets more quota
```

---

## ðŸ“± Mobile App Integration

```
App.tsx
   â”‚
   â”œâ”€â”€> AuthProvider
   â”‚    Manages authentication state
   â”‚
   â””â”€â”€> Navigation Stack
        â”œâ”€â”€> AuthScreen (Login)
        â”‚
        â”œâ”€â”€> MainDashboard
        â”‚    â”œâ”€â”€> HomeScreen
        â”‚    â”œâ”€â”€> PaymentScreen (new)
        â”‚    â”œâ”€â”€> ProfileScreen
        â”‚    â””â”€â”€> HistoryScreen
        â”‚
        â””â”€â”€> When plan changes
             User gets premium features
```

---

## ðŸ›¡ï¸ Security Layers

```
Layer 1: Transport Security
â”œâ”€â”€> HTTPS encryption
â”œâ”€â”€> TLS 1.2+
â””â”€â”€> Certificate pinning (optional)

Layer 2: Authentication
â”œâ”€â”€> JWT tokens
â”œâ”€â”€> Token expiration
â””â”€â”€> Secure token storage

Layer 3: API Security
â”œâ”€â”€> Token validation on each request
â”œâ”€â”€> User extraction from token
â””â”€â”€> Database ORM (SQL injection prevention)

Layer 4: Payment Security
â”œâ”€â”€> Signature verification
â”œâ”€â”€> HMAC-SHA256 hashing
â”œâ”€â”€> Secret key never exposed
â””â”€â”€> No card data storage (Razorpay PCI-DSS)

Layer 5: Data Security
â”œâ”€â”€> Sensitive data logging excluded
â”œâ”€â”€> Transaction records immutable
â”œâ”€â”€> Audit trail of all payments
â””â”€â”€> Refund tracking
```

---

## ðŸ”„ Error Handling Flow

```
User Action
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Try-Catch Block     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API Call    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Error?        â”‚ â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚    YES      NO   â”‚
â”‚     â”‚       â”‚    â”‚
â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
      â”‚       â”‚
      â–¼       â–¼
   Error    Success
  Message   Response
     â”‚        â”‚
     â–¼        â–¼
  Alert    Update UI
  Log      Update DB
  Return   Return data
```

---

## ðŸ“ˆ Performance Metrics

```
Payment Processing Pipeline
â”œâ”€â”€> Order Creation: ~500ms (API call to Razorpay)
â”œâ”€â”€> Checkout Load: ~2000ms (Script load + modal render)
â”œâ”€â”€> Payment Processing: ~3000-5000ms (User input + card processing)
â”œâ”€â”€> Verification: ~200ms (Signature verification)
â””â”€â”€> Total: ~5.7-8.2 seconds

Database Operations
â”œâ”€â”€> Create Payment Record: ~50ms
â”œâ”€â”€> Update Subscription: ~50ms
â”œâ”€â”€> Fetch History: ~100ms (< 100 records)
â””â”€â”€> Total: ~200ms
```

---

## ðŸš€ Deployment Architecture

### Development
```
localhost:8003 (Backend)
    â”‚
    â”œâ”€â”€> SQLite database
    â”œâ”€â”€> Razorpay test keys
    â””â”€â”€> Debug=True

localhost:8081 (Frontend)
    â”‚
    â”œâ”€â”€> Dev server
    â”œâ”€â”€> Hot reload
    â””â”€â”€> API_URL=localhost:8003
```

### Production
```
yourdomain.com/api (Backend)
    â”‚
    â”œâ”€â”€> PostgreSQL database
    â”œâ”€â”€> Razorpay live keys
    â”œâ”€â”€> HTTPS/SSL
    â””â”€â”€> Debug=False

yourdomain.com (Frontend)
    â”‚
    â”œâ”€â”€> CDN distribution
    â”œâ”€â”€> Production build
    â””â”€â”€> API_URL=yourdomain.com/api
```

---

**This architecture provides:**
- âœ… Secure payment processing
- âœ… Scalable design
- âœ… Clear separation of concerns
- âœ… Comprehensive error handling
- âœ… Audit trail for compliance

